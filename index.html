<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson 9 Exercises 仮定法</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
        }
        .control-button:hover {
            transform: scale(1.1);
            transition: transform 0.2s;
        }
        .highlight {
            color: #16A34A; /* green-600 */
            font-weight: bold;
        }
        .placeholder {
            color: #3B82F6; /* blue-500 */
            font-weight: bold;
        }
        .explanation-panel, .recognition-panel {
            transition: all 0.3s ease-in-out;
        }
        .recording {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .error-location {
             /* Optional: You might want subtle indication, like a faint underline */
             /* border-bottom: 1px dotted #ccc; */
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Lesson 9 Exercises</h1>
            <p class="text-gray-600 mt-2">仮定法 練習問題</p>
        </header>

        <main class="space-y-6" id="main-content">
            <section>
                <h2 class="text-2xl font-bold text-gray-700 border-l-4 border-blue-500 pl-4 mb-4">1. 空所補充</h2>
                <div id="sentences-1" class="space-y-4"></div>
            </section>
            <section>
                <h2 class="text-2xl font-bold text-gray-700 border-l-4 border-green-500 pl-4 mb-4">2. 語句補充</h2>
                <div id="sentences-2" class="space-y-4"></div>
            </section>
            <section>
                <h2 class="text-2xl font-bold text-gray-700 border-l-4 border-yellow-500 pl-4 mb-4">3. 文法上の誤り指摘</h2>
                <div id="sentences-3" class="space-y-4"></div>
            </section>
            <section>
                <h2 class="text-2xl font-bold text-gray-700 border-l-4 border-purple-500 pl-4 mb-4">4. 語句整序</h2>
                <div id="sentences-4" class="space-y-4"></div>
            </section>
            <section>
                <h2 class="text-2xl font-bold text-gray-700 border-l-4 border-red-500 pl-4 mb-4">5. 和文英訳</h2>
                <div id="sentences-5" class="space-y-4"></div>
            </section>
        </main>
    </div>

    <script>
        const sentences = [
            // Categories 1, 2, 3, 4 remain the same...
             // 1. 空所補充 (Category 1)
            { id: 1, category: '1', en: "If <span class='placeholder'>(&emsp;&emsp;&emsp;)</span> <span class='placeholder'>(&emsp;&emsp;&emsp;)</span> <span class='placeholder'>(&emsp;&emsp;&emsp;)</span>, I wouldn’t travel alone.", jp: "もし私があなたなら，1人で旅行しないだろう。", explanation: "「もし私があなたなら」のような実際に起こり得ないことは仮定法過去〈If S’＋過去形, S would＋動詞の原形〉で表す。If ( I ) ( was ) ( you)としても誤りではないが，If I were you「もし私があなたなら」という定型句となっており，発音もしやすく，普通はwereを使う。", answers: ["I", "were", "you"] }, // Renamed 'answer' to 'answers'
            { id: 2, category: '1', en: "I wish <span class='placeholder'>(&emsp;&emsp;&emsp;)</span> <span class='placeholder'>(&emsp;&emsp;&emsp;)</span> <span class='placeholder'>(&emsp;&emsp;&emsp;)</span> a prior engagement. I could have come to your party.", jp: "先約がなかったらなあ。君のパーティーに行けたのに。", explanation: "「先約がなかったらなあ」は過去の事実に反する願望なので，〈S wish S’ had＋過去分詞〉を使う。「先約」はprior engagement。", answers: ["I", "hadn't", "had"] },
            { id: 3, category: '1', en: "What would your family think if <span class='placeholder'>(&emsp;&emsp;&emsp;)</span> <span class='placeholder'>(&emsp;&emsp;&emsp;)</span> <span class='placeholder'>(&emsp;&emsp;&emsp;)</span> be transferred abroad for work?", jp: "仮にあなたが海外に転勤になるとしたら，あなたの家族はどう思いますか。", explanation: "仮の話の前提は〈If S’ were to＋動詞の原形, S＋would＋動詞の原形〉で表す。実現の可能性がゼロの仮定から実現の可能性がある仮定まで表せる。", answers: ["you", "were", "to"] },
            { id: 4, category: '1', en: "Linda could not have brought up their twin babies <span class='placeholder'>(&emsp;&emsp;&emsp;)</span> <span class='placeholder'>(&emsp;&emsp;&emsp;)</span> <span class='placeholder'>(&emsp;&emsp;&emsp;)</span> assistance.", jp: "彼女の夫の支えがなかったら，リンダは双子の赤ん坊を育てることができなかっただろう。", explanation: "「～がなかったら」は空欄の数から〈without＋名詞句〉。", answers: ["without", "her", "husband's"] },
            { id: 5, category: '1', en: "<span class='placeholder'>(&emsp;&emsp;&emsp;)</span> <span class='placeholder'>(&emsp;&emsp;&emsp;)</span> <span class='placeholder'>(&emsp;&emsp;&emsp;)</span> would not say such a thing.", jp: "賢い人なら，そんなことを言わないだろう。", explanation: "主語が条件を表す仮定法過去の文。if節を使うと，If he were a wise man, he would not say such a thing.となる。", answers: ["A", "wise", "man"] },

            // 2. 語句補充 (Category 2)
            { id: 6, category: '2', en: "It <u class='placeholder'>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;</u> the website in advance.", jp: "前もってそのウェブサイトを確認しておくと役に立つでしょう。", explanation: "「～すると役に立つでしょう」は助動詞would を使って控えめに相手に提案する〈It would be helpful to do 〉で表すことができる。", answers: ["would be helpful to check"] },
            { id: 7, category: '2', en: "Jane talked to them <u class='placeholder'>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;</u> children.", jp: "ジェーンはまるで彼らが子どもであるかのように彼らに話しかけた。", explanation: "「まるで～かのように」と現在の事実とは異なる状況を表すには〈as if S’＋過去形〉を使う。", answers: ["as if they were"] },
            { id: 8, category: '2', en: "If <u class='placeholder'>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;</u> five minutes earlier, I would not have missed the train.", jp: "もし5分早く出ていたら，その電車に乗り遅れることはなかっただろう。", explanation: "「も し～ だったなら」と過去の事実と違うことは〈If S’ had＋過去分詞, S＋would have＋過去分詞〉を使う。", answers: ["I had left"] },
            { id: 9, category: '2', en: "If I had worked harder, my business <u class='placeholder'>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;</u> more successful now.", jp: "もっと一生懸命働いていたら，今ごろ商売はもっと成功しているだろう。", explanation: "「も し(あの時)～だったなら，(今)…だろ うに」はif節が過去の事実と違うため仮定法過去完了，主節が現在の事実と違うため仮定法過去で表す。", answers: ["would be"] },
            { id: 10, category: '2', en: "If <u class='placeholder'>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;</u> your help, I could not complete this project.", jp: "あなたの助けなしには，私はこのプロジェクトを終わらせることができないでしょう。", explanation: "「～がなければ」はifを使うと，仮定法過去の場合〈if it were not for＋名詞〉になる。＝without ～", answers: ["it were not for"] },

             // 3. 文法上の誤り指摘 (Category 3)
            { id: 11, category: '3', en: "My sister will be going on an excursion tomorrow if it <span class='error-location'>were</span> sunny.", jp: "晴れなら，姉 [妹] は明日，遠足に行く。", incorrect: "were", correct: "is", explanation: "実現の可能性があるので直説法で表す。ifで導く副詞節では未来のことも現在形。" },
            { id: 12, category: '3', en: "It is about time you <span class='error-location'>start</span> to prepare for the exam.", jp: "そろそろ試験の準備を始めてもよい頃だ。", incorrect: "start", correct: "started", explanation: "まだしていない行為を促す〈It is about time＋仮定法過去〉。" },
            { id: 13, category: '3', en: "I ran to the station; otherwise I might <span class='error-location'>miss</span> the train.", jp: "駅まで走った。さもなければ電車に乗り遅れたかもしれない。", incorrect: "miss", correct: "have missed", explanation: "otherwiseは「そうでなければ」という意味で，直前に述べられている事実に反する仮定を表す。ここでは，過去の事実に反する条件を表すので，otherwiseの後は仮定法過去完了にする。" },
            { id: 14, category: '3', en: "When we met at the welcoming reception, we felt as if we <span class='error-location'>have</span> known each other for years.", jp: "歓迎会で会った時，私たちは長年の知り合いであるかのように感じた。", incorrect: "have", correct: "had", explanation: "as ifの後は過去の事実に反することなので，仮定法過去完了にする。" },
            { id: 15, category: '3', en: "If only Takashi <span class='error-location'>left</span> home five minutes later, he would not have been involved in the car accident.", jp: "タカシが5分遅く家を出てさえいれば，車の事故に巻き込まれなかっただろうに。", incorrect: "left", correct: "had left", explanation: "if onlyはI wishと似た意味で，事実に反する強い願望を表す。過去の事実に反するので仮定法過去完了にする。" },


            // 4. 語句整序 (Category 4)
            { id: 16, category: '4', en: "Jane was very pale. She <span class='placeholder'>( as / had / if / looked / seen / she )</span> a ghost.", jp: "ジェーンはとても青白い顔をしていた。まるで幽霊を見たかのようだった。", scrambled: "( as / had / if / looked / seen / she )", answers: ["looked as if she had seen"], explanation: "「まるで～したかのよう」は〈as if S’ had＋過去分詞 〉で表す。" },
            { id: 17, category: '4', en: "I saw it with my own eyes; <span class='placeholder'>( I / believed / have / otherwise / wouldn’t / it )</span>.", jp: "自分の目でそれを見たが，そうでなければそれを信じなかっただろう。", scrambled: "( I / believed / have / otherwise / wouldn’t / it )", answers: ["otherwise I wouldn’t have believed it"], explanation: "「そうでなければ」は副詞otherwiseをセミコロン(;)の後ろに置き，仮定法を続ける。" },
            { id: 18, category: '4', en: "<span class='placeholder'>( been / for / had / if / it / not / that )</span> defensive play, we would have lost the game.", jp: "あのうまい守りがなければ，そのゲームに負けてしまったであろう。", scrambled: "( been / for / had / if / it / not / that )", answers: ["If it had not been for that"], explanation: "「～がなければ」は仮定法過去完了の場合，〈if it had not been for＋名詞〉となる。" },
            { id: 19, category: '4', en: "I have trouble with university math. <span class='placeholder'>( had / I / I / more / studied / wish )</span> in high school.", jp: "大学の数学に苦労している。高校時代にもっと勉強しておけばなあ。", scrambled: "( had / I / I / more / studied / wish )", answers: ["I wish I had studied more"], explanation: "「～していたらなあ，～しておけばなあ」は〈I wish S’ had＋過去分詞〉。" },

            // 5. 和文英訳 (Category 5) - Updated with multiple answers
            { id: 20, category: '5', en: "", jp: "雨が降っていなければ出かけるところなのだが。",
              answers: [
                  "I’d go out if it wasn’t raining.", // weren't is also possible
                  "If it wasn’t raining, I would go out." // weren't is also possible
              ],
              explanation: "現在の事実に反することなので，仮定法過去。"
            },
            { id: 21, category: '5', en: "", jp: "試験なんてものがなければいいのに。",
              answers: ["I wish there were no such things as exams."],
              explanation: "「～ならいいのに」という実現が困難な願望は，仮定法過去の〈I wish S’＋過去形〉で表す。「～のようなもの」は〈such things as ～〉。"
            },
            { id: 22, category: '5', en: "", jp: "時間とお金が十分にあったら，彼女は留学しただろうに。",
              answers: ["If she had had enough time and money, she would have studied abroad."],
              explanation: "「～があったら」は「～を持っていたら」と考える。〈with＋名詞句〉を使って，With enough time and money, … としてもよい。"
            },
            { id: 23, category: '5', en: "", jp: "もしあなたの助言がなかったら，私は事業に失敗していたでしょう。",
              answers: [
                  "If it had not been for your advice, I would have failed in my business.",
                  "Without your advice, I would have failed in my business." // Added alternative from explanation
              ],
              explanation: "「～がなかったら」は〈If it had not been for＋名詞〉または〈Without＋名詞〉で表す。「事業に失敗する」fail in (one’s) business [one’s venture]。"
            },
            { id: 24, category: '5', en: "", jp: "子どもたちのように，私も若い時にアメリカに来ていたらなあ。",
              answers: [
                  "I wish I had come to the US when I was young, like my children.",
                  "I wish I had come to America when I was young, like my children." // Added alternative from explanation
              ],
              explanation: "「～していたらなあ」は〈I wish＋仮定法過去完了〉。the USの代わりにAmericaを使ってもよい。"
            }
        ];

        // --- JavaScript code for recognition, similarity etc. remains the same ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        let mediaRecorder;
        let mediaStream;
        let americanVoice = null;

        function loadAndSetVoice() { /* ... */ }
        loadAndSetVoice();
        if (speechSynthesis.onvoiceschanged !== undefined) { /* ... */ }
        if (SpeechRecognition) { /* ... */ } else { /* ... */ }
        function calculateSimilarity(s1, s2) { /* ... */ }
        function editDistance(s1, s2) { /* ... */ }
        function handleRecording(sentence, recordButton, resultPanel) { /* ... */ }
        // Function to load and select a high-quality American English voice
        function loadAndSetVoice() {
            const voices = speechSynthesis.getVoices();
            if (voices.length === 0) return;
            americanVoice = voices.find(voice => voice.name === 'Google US English') ||
                            voices.find(voice => voice.name === 'Samantha') ||
                            voices.find(voice => voice.lang === 'en-US' && voice.name.includes('Google')) ||
                            voices.find(voice => voice.lang === 'en-US');
        }
        loadAndSetVoice();
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = loadAndSetVoice;
        }
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
        } else {
            console.log("Speech Recognition Not Supported");
        }
        function calculateSimilarity(s1, s2) {
            let longer = s1;
            let shorter = s2;
            if (s1.length < s2.length) { longer = s2; shorter = s1; }
            let longerLength = longer.length;
            if (longerLength === 0) return 1.0;
            return (longerLength - editDistance(longer, shorter)) / parseFloat(longerLength);
        }
        function editDistance(s1, s2) {
            s1 = s1.toLowerCase(); s2 = s2.toLowerCase();
            const costs = [];
            for (let i = 0; i <= s1.length; i++) {
                let lastValue = i;
                for (let j = 0; j <= s2.length; j++) {
                    if (i == 0) costs[j] = j;
                    else {
                        if (j > 0) {
                            let newValue = costs[j - 1];
                            if (s1.charAt(i - 1) != s2.charAt(j - 1))
                                newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                            costs[j - 1] = lastValue;
                            lastValue = newValue;
                        }
                    }
                }
                if (i > 0) costs[s2.length] = lastValue;
            }
            return costs[s2.length];
        }
       function handleRecording(getTextToCompare, recordButton, resultPanel) { // Modified to accept a function
            if (!recognition) {
                resultPanel.innerHTML = `<p class="text-red-500">お使いのブラウザは音声認識に対応していません。</p>`;
                return;
            }
            if (recordButton.classList.contains('recording')) {
                recognition.stop();
                return;
            }
            resultPanel.innerHTML = '';

            // Get the current text to compare right before starting
            const currentSentence = getTextToCompare();
            if (!currentSentence) {
                resultPanel.innerHTML = `<p class="text-yellow-600">比較する英文がありません。</p>`;
                return;
            }


            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaStream = stream;
                    mediaRecorder = new MediaRecorder(stream);
                    let audioChunks = [];
                    mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                    mediaRecorder.onstop = () => {
                         if (audioChunks.length === 0) return;
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        setTimeout(() => {
                            if (resultPanel.innerHTML.trim() !== '' && !resultPanel.querySelector('.playback-div')) {
                                const playbackDiv = document.createElement('div');
                                playbackDiv.className = 'playback-div flex items-center space-x-2 mt-3 pt-3 border-t border-gray-200';
                                playbackDiv.innerHTML = `<button class="control-button p-2 rounded-full bg-indigo-500 text-white hover:bg-indigo-600 focus:outline-none"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg></button><p class="text-sm text-gray-600">自分の音声を確認する</p>`;
                                const audioPlayer = new Audio(audioUrl);
                                playbackDiv.querySelector('button').onclick = () => audioPlayer.play();
                                resultPanel.appendChild(playbackDiv);
                            }
                        }, 100);
                        audioChunks = [];
                    };
                    recognition.start();
                    recognition.onstart = () => {
                        recordButton.classList.add('recording', 'bg-red-500'); recordButton.classList.remove('bg-green-500');
                        recordButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M9 10h.01M15 10h.01M9 14h6" /></svg>`;
                        resultPanel.innerHTML = `<p class="text-gray-500">録音中...</p>`;
                        mediaRecorder.start();
                    };
                    recognition.onend = () => {
                        recordButton.classList.remove('recording', 'bg-red-500'); recordButton.classList.add('bg-green-500');
                        recordButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v3a3 3 0 01-3 3z" /></svg>`;
                        if (mediaRecorder?.state === 'recording') mediaRecorder.stop();
                        mediaStream?.getTracks().forEach(track => track.stop());
                    };
                    recognition.onresult = (event) => {
                        if (!event.results?.[0]?.[0]?.transcript) { /* ... error handling ... */ return; }
                        const transcript = event.results[0][0].transcript;
                        const cleanOriginal = currentSentence.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"").replace(/\s\s+/g, ' ').trim().toLowerCase(); // Use currentSentence
                        const cleanTranscript = transcript.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"").replace(/\s\s+/g, ' ').trim().toLowerCase();
                        const similarity = calculateSimilarity(cleanOriginal, cleanTranscript);
                        const score = Math.round(similarity * 100);
                        let feedback = score >= 85 ? '素晴らしい！' : score >= 65 ? '惜しい！' : 'もう一度！';
                        let colorClass = score >= 85 ? 'text-green-600' : score >= 65 ? 'text-yellow-600' : 'text-red-600';
                        const resultDiv = document.createElement('div');
                        resultDiv.innerHTML = `<p class="text-gray-800">あなたの発音: 「${transcript}」</p><div class="flex items-center mt-2"><p class="font-bold ${colorClass}">${feedback}</p><p class="ml-4 text-sm text-gray-600">スコア: ${score}点</p></div>`;
                        resultPanel.innerHTML = '';
                        resultPanel.appendChild(resultDiv);
                    };
                    recognition.onerror = (event) => { /* ... error handling ... */ };
                })
                .catch(err => { /* ... error handling ... */ });
        }


        function createSentenceCard(sentence) {
            const card = document.createElement('div');
            card.className = 'bg-white p-4 rounded-lg shadow-md';
            const contentAndControls = document.createElement('div');
            contentAndControls.className = 'flex items-start space-x-4';
            const numberDiv = document.createElement('div');
            numberDiv.className = 'flex-shrink-0 bg-gray-200 text-gray-700 font-bold rounded-full h-8 w-8 flex items-center justify-center text-sm';
            numberDiv.textContent = String(sentence.id);
            const textContentDiv = document.createElement('div');
            textContentDiv.className = 'flex-grow';
            const enP = document.createElement('p');
            enP.className = 'text-lg text-gray-800 font-medium';
            const jpP = document.createElement('p');
            jpP.className = 'text-gray-600 mt-1';
            jpP.textContent = sentence.jp;
            const controlsDiv = document.createElement('div');
            controlsDiv.className = 'flex flex-col items-center space-y-2 ml-2';
            const audioButton = document.createElement('button');
            audioButton.className = 'control-button p-2 rounded-full bg-blue-500 text-white hover:bg-blue-600 focus:outline-none';
            audioButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>`;
            const recordButton = document.createElement('button');
            recordButton.className = 'control-button p-2 rounded-full bg-green-500 text-white hover:bg-green-600 focus:outline-none';
            recordButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v3a3 3 0 01-3 3z" /></svg>`;
            const buttonGroup = document.createElement('div');
            buttonGroup.className = 'flex items-center space-x-2 mt-2';
            const toggleAnswerButton = document.createElement('button');
            toggleAnswerButton.className = 'control-button text-xs px-2 py-1 bg-yellow-400 text-yellow-800 rounded-md hover:bg-yellow-500';
            toggleAnswerButton.textContent = '解答表示';
            const toggleButton = document.createElement('button');
            toggleButton.className = 'control-button text-xs px-2 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300';
            toggleButton.textContent = '解説';

            const stripHtml = (html) => {
               if (!html) return "";
               let tmp = document.createElement("DIV");
               tmp.innerHTML = html;
               return tmp.textContent || tmp.innerText || "";
            }

            // Function to get the text of the currently displayed answer (for audio/recording)
            const getCurrentEnText = () => {
                // For category 5 with cycling answers
                if (sentence.category === '5' && sentence.answers && sentence.answers.length > 0) {
                     if (currentAnswerIndex === -1) return null; // Placeholder shown
                     return stripHtml(sentence.answers[currentAnswerIndex]);
                }
                 // For category 3, get text based on whether answer is shown
                 if (sentence.category === '3') {
                     // Check current innerHTML to see which state it's in
                     if (enP.innerHTML.includes('highlight')) { // Correct answer is shown
                        return stripHtml(sentence.correct);
                     } else { // Default (incorrect) answer is shown
                        return stripHtml(sentence.incorrect);
                     }
                 }
                // For other categories, determine based on isAnswerShown flag
                 if (isAnswerShown && sentence.answers && sentence.answers.length > 0) {

                    let tempEn = sentence.en; // Start with the template
                     // The 'answers' array for Cat 1, 2, 4 contains the parts to fill in/replace placeholders
                    let answersToUse = sentence.answers;

                    // Reconstruct the correct sentence for Cat 1, 2, 4
                    if (sentence.category === '1' || sentence.category === '2' || sentence.category === '4') {
                         answersToUse.forEach(ans => {
                             // Replace placeholders sequentially
                             tempEn = tempEn.replace(/<span class='placeholder'>.*?<\/span>/, ans);
                             tempEn = tempEn.replace(/<u class='placeholder'>.*?<\/u>/, ans);
                         });
                    } else {
                        // This case shouldn't be reached if other categories are handled above
                        tempEn = "";
                    }

                    return stripHtml(tempEn);
                }
                 // If answer isn't shown for Cat 1, 2, 4, or other cases
                 return null; // Indicate no valid EN answer text available
            };


            audioButton.onclick = () => {
                if (speechSynthesis.speaking) speechSynthesis.cancel();
                const textToSpeak = getCurrentEnText(); // Get current text
                if (textToSpeak) {
                    const utterance = new SpeechSynthesisUtterance(textToSpeak);
                    if (americanVoice) utterance.voice = americanVoice;
                    else utterance.lang = 'en-US';
                    utterance.rate = 1.0; utterance.pitch = 1.0;
                    speechSynthesis.speak(utterance);
                } else {
                    console.log("No English text to speak.");
                     // Optionally provide feedback to the user
                }
            };

            const recognitionPanel = document.createElement('div');
            recognitionPanel.className = 'recognition-panel mt-3';
            // Pass the function itself to handleRecording
            recordButton.onclick = () => handleRecording(getCurrentEnText, recordButton, recognitionPanel);


            let isAnswerShown = false; // General flag
            let currentAnswerIndex = -1; // For category 5 cycling (-1 means placeholder)

            // --- Category Specific Display Logic ---
             if (sentence.category === '5') {
                 const placeholderHTML = `<span class="placeholder">英文を入力...</span>`;
                 enP.innerHTML = placeholderHTML;
                 const numAnswers = sentence.answers ? sentence.answers.length : 0;

                 toggleAnswerButton.onclick = () => {
                     currentAnswerIndex++;
                     if (currentAnswerIndex >= numAnswers) {
                         currentAnswerIndex = -1; // Cycle back to placeholder
                     }

                     if (currentAnswerIndex === -1) {
                         enP.innerHTML = placeholderHTML;
                         toggleAnswerButton.textContent = '解答1表示';
                     } else {
                         enP.innerHTML = `<span class="highlight">${sentence.answers[currentAnswerIndex]}</span>`;
                         toggleAnswerButton.textContent = (currentAnswerIndex + 1 < numAnswers)
                             ? `解答${currentAnswerIndex + 2}表示`
                             : '問題文表示';
                     }
                 };
                 // Initial button text
                 toggleAnswerButton.textContent = numAnswers > 0 ? '解答1表示' : '解答表示';

            } else if (sentence.category === '4') {
                 // Keep using isAnswerShown flag
                 const scrambledHTML = sentence.en.replace(/<span class='placeholder'>.*?<\/span>/, `<span class='placeholder'>${sentence.scrambled}</span>`);
                 const correctHTML = sentence.en.replace(/<span class='placeholder'>.*?<\/span>/, `<span class='highlight'>${sentence.answers[0]}</span>`); // Assumes answers[0]
                 enP.innerHTML = scrambledHTML;
                 toggleAnswerButton.onclick = () => {
                     isAnswerShown = !isAnswerShown;
                     enP.innerHTML = isAnswerShown ? correctHTML : scrambledHTML;
                     toggleAnswerButton.textContent = isAnswerShown ? '問題文表示' : '解答表示';
                 };
            } else if (sentence.category === '3') {
                 // Keep using isAnswerShown flag
                 const defaultHTML = sentence.en.replace(/<span class='error-location'>(.*?)<\/span>/, `<span class='error-location'>${sentence.incorrect}</span>`);
                 const correctHTML = sentence.en.replace(/<span class='error-location'>.*?<\/span>/, `<span class='highlight'>${sentence.correct}</span>`);
                 enP.innerHTML = defaultHTML;
                 toggleAnswerButton.textContent = '修正表示';
                 toggleAnswerButton.onclick = () => {
                     isAnswerShown = !isAnswerShown;
                     enP.innerHTML = isAnswerShown ? correctHTML : defaultHTML;
                     toggleAnswerButton.textContent = isAnswerShown ? '問題文表示' : '修正表示';
                 };
            }
             else { // Categories '1' & '2' - Keep using isAnswerShown flag
                let answersToUse = Array.isArray(sentence.answers) ? sentence.answers : []; // Ensure it's an array, default to empty
                let hiddenHTML = sentence.en;
                let correctHTML = sentence.en;

                 // Only attempt replacement if answers exist
                 if(answersToUse.length > 0) {
                     answersToUse.forEach(ans => {
                         correctHTML = correctHTML.replace(/<span class='placeholder'>.*?<\/span>/, `<span class='highlight'>${ans}</span>`);
                         correctHTML = correctHTML.replace(/<u class='placeholder'>.*?<\/u>/, `<span class='highlight'>${ans}</span>`);
                     });
                 }


                 if (sentence.category === '2') {
                     hiddenHTML = hiddenHTML.replace(/<u class='placeholder'>.*?<\/u>/, `<u class='placeholder'>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;</u>`);
                 } else { // Category 1
                     hiddenHTML = hiddenHTML.replace(/<span class='placeholder'>.*?<\/span>/g, ` <span class='placeholder'>(&emsp;&emsp;&emsp;)</span> `);
                 }

                hiddenHTML = hiddenHTML.trim().replace(/\s\s+/g, ' ');
                correctHTML = correctHTML.trim().replace(/\s\s+/g, ' ');

                enP.innerHTML = hiddenHTML;
                 toggleAnswerButton.onclick = () => {
                     isAnswerShown = !isAnswerShown;
                     enP.innerHTML = isAnswerShown ? correctHTML : hiddenHTML;
                     toggleAnswerButton.textContent = isAnswerShown ? '問題文表示' : '解答表示';
                 };
            }

            // --- Common elements ---
            textContentDiv.appendChild(enP);
            textContentDiv.appendChild(jpP);
            buttonGroup.appendChild(toggleAnswerButton);
            buttonGroup.appendChild(toggleButton);
            controlsDiv.appendChild(audioButton);
            controlsDiv.appendChild(recordButton);
            controlsDiv.appendChild(buttonGroup);
            contentAndControls.appendChild(numberDiv);
            contentAndControls.appendChild(textContentDiv);
            contentAndControls.appendChild(controlsDiv);

            const explanationPanel = document.createElement('div');
            explanationPanel.className = 'explanation-panel hidden mt-3 pt-3 border-t border-gray-200';
            explanationPanel.innerHTML = `<p class="text-gray-700 bg-gray-50 p-3 rounded-md">${sentence.explanation || '解説はありません。'}</p>`;
            toggleButton.onclick = () => explanationPanel.classList.toggle('hidden');

            card.appendChild(contentAndControls);
            card.appendChild(explanationPanel);
            card.appendChild(recognitionPanel);

            return card;
        }

        function renderSentences() {
             if (!SpeechRecognition) { /* ... warning message ... */ }

            const containers = {
              '1': document.getElementById('sentences-1'),
              '2': document.getElementById('sentences-2'),
              '3': document.getElementById('sentences-3'),
              '4': document.getElementById('sentences-4'),
              '5': document.getElementById('sentences-5'),
            }; // Added missing closing brace '}' here


            Object.values(containers).forEach(container => { if (container) container.innerHTML = ''; }); // Clear all containers initially


            sentences.forEach(sentence => {
                 // Simplified check for category 3 validity
                 if (sentence.category === '3' && (typeof sentence.incorrect === 'undefined' || typeof sentence.correct === 'undefined')) {
                    console.warn(`Skipping sentence ID ${sentence.id} in Category 3 due to missing incorrect/correct data.`);
                    return;
                }
                 // Check for category 5 validity
                 if (sentence.category === '5' && (!sentence.answers || !Array.isArray(sentence.answers) || sentence.answers.length === 0)) {
                     console.warn(`Skipping sentence ID ${sentence.id} in Category 5 due to missing or invalid answers array.`);
                    return;
                 }
                 // Convert single answer string/array to array for consistency (Categories 1, 2, 4)
                 if (['1', '2', '4'].includes(sentence.category) && sentence.answers && !Array.isArray(sentence.answers)) {
                     // If 'answers' exists and is not an array (likely a string from Cat 2/4), wrap it
                      sentence.answers = [sentence.answers];
                 } else if (['1', '2', '4'].includes(sentence.category) && !sentence.answers && sentence.answer) {
                    // LEGACY SUPPORT: If 'answers' doesn't exist but old 'answer' does
                    sentence.answers = Array.isArray(sentence.answer) ? sentence.answer : [sentence.answer];
                    delete sentence.answer; // Clean up old property
                 } else if (['1', '2', '4'].includes(sentence.category) && !sentence.answers) {
                     // If neither exists, initialize to empty array to prevent errors
                     sentence.answers = [];
                     console.warn(`Sentence ID ${sentence.id} (Cat ${sentence.category}) has no answer data.`);
                 }


                const card = createSentenceCard(sentence);
                 // Ensure container exists before appending
                 if (containers[sentence.category]) {
                     containers[sentence.category].appendChild(card);
                 } else {
                      console.warn(`Container for category ${sentence.category} not found.`);
                 }
            });
        }

        document.addEventListener('DOMContentLoaded', renderSentences);
    </script>
</body>
</html>